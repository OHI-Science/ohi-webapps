# ohirepos

# Overview

The `ohirepos` package is for creating OHI repos to be used for OHI assessments. These repos by default are created within the [OHI-Science](https://github.com/OHI-Science/) GitHub organization, and to do so you will need be part of the OHI team with administration privileges. To request a repository, please follow [these instructions](http://ohi-science.org/manual/#requesting-your-repositories).

The `ohirepos` package will...

# Installation

```{r, eval = FALSE}
# install.packages("devtools")
devtools::install_github("ohi-science/ohirepos")
```


# Usage 

First, you'll need to do 2 things: 

1. Add info by hand to `ohi-webapps/repo_registry.csv` ## TODO: turn this into a googlesheet
2. Create new repo on github.com/OHI-Science called `key`.

# Initial Setup

## Assign variables

You will need to assign the following variables based on the repository you want to created. 

```{r assign variables, eval=FALSE}

## set the repo key; this example is for the Baltic:
key <- 'ohi-northeast' 

## set the study_area; this example is for the Baltic: 
study_area <- 'Northeast USA' ## or pull this from repo_registry...or input it?

## set the directory where you want to work locally on your computer: 
dir_temp <- '~/github/clip-n-ship'

```

# Create repo on GitHub.com and register repo

**the first thing you'll do is go to [https://github.com/OHI-Science](github.com/OHI-Science) and create a new repo named `key`**. This key must match the key you set above (and is case-sensitive). 

TODO: figure out when to mention the repo_registry and archive past work
```{r, eval=FALSE}
# read in repo_registry
repo_registry = readr::read_csv('repo_registry.csv')
```


## Load libraries, build variables, create working directory

These variables are built based on the variables you set above.

```{r setup libraries, eval=FALSE}

## load libraries
# devtools::install_github("ohi-science/ohirepos")
library(ohirepos) # devtools::load_all('~/github/ohirepos') 


## build variables 
dir_repo <- file.path(dir_temp, key)



## create working dir
dir.create(dir_repo)


# dir_work <- path.expand('~/github/ohi-webapps') # get rid of any reliance on ohi-webapps
## load this stuff from ohirepos.
# source(file.path(dir_work, 'common.r'))
# source(file.path(dir_work, 'create_init_sc.R'))
```


# Create and populate Starter Repo

The Starter Repo has some initial files including a README, as well as a `prep` folder with sub-folders for every goal and sub-goal. The default for these functions is to push updates to github.com/ohi-science/`key`.

```{r, eval=FALSE}
ohirepos::populate_init(key, dir_repo, push = TRUE)
ohirepos::populate_prep(key, dir_repo, push = TRUE)
```

See the OHI Manual section on [requesting your repositories](http://ohi-science.org/manual/#requesting-your-repositories) for more information between the Starter Repo and the Full Repo.


## Inspect user's shapefiles and save as OHI shapefiles

If you are storing shapefiles on the NCEAS server Mazu, here are some shortcuts: 

# dir_M <- c('Windows' = '//mazu.nceas.ucsb.edu/ohi',
#            'Darwin'  = '/Volumes/ohi',    ### connect (cmd-K) to smb://mazu/ohi
#            'Linux'   = '/home/shares/ohi')[[ Sys.info()[['sysname']] ]]

This occurs in the /custom folder. A running list: 

- chl/prep_chl.Rmd
- cnc/prep_cnc.Rmd
- rdv/prep_rdv.Rmd
- arc/prep_arc.Rmd



## Create prep website

```{r, eval=FALSE}
ohirepos::deploy_website_prep(key, dir_repo, push = TRUE)


## Actually am supposed to have deploy_website work with prep or not


```


## Potential Step(s) Here
- Unpopulate Existing Repo (see chunk below)


## Populate Full Repo
This doesn't push, just populates.
```{r populate, eval=FALSE}
## populate layers folder and layers.csv, and conf
populate_layers(key, dir_repo, dir_origin, dir_scenario, multi_nation = FALSE)
populate_conf(key, dir_scenario, dir_origin) ## look at TODOs in functions.r
populate_etc(key, dir_scenario)

# TODO: delete preGlobalScores(), substitute repo name in flower/map creation

## create repo's maps
create_repo_map(key, dir_spatial, dir_scenario) 
```


## Calculate scores and create scores.csv
Can also test this from the repo itself (open the the clip-n-ship/key/.rproj)
```{r calculate, eval=FALSE}
## calculate scores and create scores.csv
calculate_scores_check(dir_scenario)
```


## Push!
```{r push, eval=FALSE}
# push repo
setwd(dir_repo)
push_branch(branch = 'master', current_msg = 'created full repo') 
## TODO: 
# push_branch(branch = 'master', current_msg = 'created full repo') 
# [dev 81be48d]  created full repo
#  3 files changed, 16 insertions(+), 4 deletions(-)
# error: cannot run rpostback-askpass: No such file or directory
# fatal: could not read Password for 'https://d80e7cc2b2d65cd77347193263ecaf3ae06873a5@github.com': Device not configured
```



# Other functionality

## Rename scenario
(Optional)

Examples: 

- chl became region2016 instead of subcountry2014.

```{r rename scenario, eval=FALSE}
## rename subcountry2014 -> region2016. 
file.rename(from = file.path(dir_repo, 'subcountry2014'),
            to   = file.path(dir_repo, 'region2016'))
```

## Unpopulate Existing Repo
(Optional)

Delete contents so can start afresh, for example if a full repo exists but needs to be recreated with more regions.

```{r unpopulate, eval=FALSE}
## unpopulate_layers_conf
unpopulate_layers_conf(key, dir_work, dir_repo, git_url, default_scenario)

## a few extra files to delete from CHL: 
also_delete <- paste(dir_repo, 
                     c('copy_webapps_templates.r', 'ohi-travis-functions.R', 'travis-tool.sh'), sep = '/')
unlink(also_delete, recursive = TRUE, force = TRUE)
```


## Rename draft to master Part 1
```{r, eval=FALSE}
system('git status')
system('git branch -m draft master')
system('git branch')

push_branch(branch = 'master', current_msg = 'renamed draft branch to master branch') 
```

## Rename draft to master Part 2: Delete draft by hand on GitHub
