# Creating OHI repos

This is to create OHI repos using the package `ohirepos`. There are several different things you may want to do...


# Create repo on GitHub.com and register repo

1. first thing you'll do is go to [https://github.com/OHI-Science](github.com/OHI-Science) and create a new repo named `key`**. This key must match the key you set above (and is case-sensitive). 
Check out rgn_global.csv to cross-check global name and rgn_id to populate the repo.

2. Add info by hand to `ohi-webapps/repo_registry.csv` 


# Initial Setup

## Assign variables

You will need to assign two variables based on the repository you want to created. 

1. repo key (an example for the Baltic: `key <- 'bhi'`)
2. temporary directory where you want to work locally on your computer

```{r assign variables, eval=FALSE}
## you set these variables
key <- 'test3'
dir_temp <- '~/github/clip-n-ship'

## libraries
devtools::load_all('~/github/ohirepos') # or devtools::install_github("ohi-science/ohirepos")
library(ohirepos) 
library(tidyverse)
# library(git2r) # devtools::install_github("ropensci/git2r")

## read in repo registry information, with working directory for repo 
repo_registry <- readr::read_csv('repo_registry.csv') %>%
  dplyr::filter(study_key == key) %>%
  mutate(dir_repo = file.path(dir_temp, key))

## create working dir if it doesn't already exist
if(!file.exists(repo_registry$dir_repo)) dir.create(repo_registry$dir_repo)


# dir_work <- path.expand('~/github/ohi-webapps') # get rid of any reliance on ohi-webapps
## load this stuff from ohirepos.
# source(file.path(dir_work, 'common.r'))
# source(file.path(dir_work, 'create_init_sc.R'))

```


# Populate the Starter Repo

The Starter Repo has some initial files including a README, as well as a `prep` folder with sub-folders for every goal and sub-goal. Additionally, create and push the project website. The default for these functions is to push updates to github.com/ohi-science/`key`.

If you need to unpopulate an existing repo, there are instructions below. 

```{r, eval=FALSE}
## populate the prep repo. create a master branch repo object
repo <- ohirepos::populate_init(repo_registry, push = TRUE)
repo <- ohirepos::populate_prep(repo_registry, push = TRUE)

## deploy the website. don't create a repo object because gh-pages branch.
ohirepos::deploy_website(repo_registry, push = TRUE) 

```

See the OHI Manual section on [requesting your repositories](http://ohi-science.org/manual/#requesting-your-repositories) for more information between the Starter Repo and the Full Repo.


# Populate Full Repo

If you want to populate the full repo...You can choose the origin of the files you'll copy (it defaults to ohi-global). You have to make sure there a copy of the origin repo cloned locally. 

populate layers folder and layers.csv, this will also create the scenario folder. And then create conf.  Run these in order.

This doesn't push, just populates. --> keep this?

You may want to unpopulate your repo first if you're starting over (i.e. redefining regions). 

You'll run these as a suite of things, so just clone during populate_layers and push as the final move after the check.

```{r populate, eval=FALSE}

repo <- ohirepos::populate_layers(repo_registry, multi_nation = FALSE)
  ## TODO come back here to make sure the empty layers don't cause a problem (removed swapping global mean stuff); still clean up.

populate_conf(repo_registry)

populate_etc(repo_registry)
  ## TODO: add viz

## create repo's maps
create_repo_map(key, dir_spatial, dir_scenario)
## TODO, check this out again! Haven't yet in the July 2017 
# -->> will need to ## Inspect user's shapefiles and save as OHI shapefiles

```


## Calculate scores and create scores.csv
Can also test this from the repo itself (open the the clip-n-ship/key/.rproj)

```{r calculate, eval=FALSE}

## calculate scores # TODO: remove ohicore@dev dependency
calculate_scores_check(repo_registry)


## and push!
commit_and_push(repo_registry, 
                commit_message = 'populating test3 yo!')
```



# Other functionality

## Rename scenario
(Optional)

Examples: 

- chl became region2016 instead of subcountry2014.

```{r rename scenario, eval=FALSE}
## rename subcountry2014 -> region2016. 
file.rename(from = file.path(dir_repo, 'subcountry2014'),
            to   = file.path(dir_repo, 'region2016'))
```

## Unpopulate Existing Repo
(Optional)

Delete contents so can start afresh, for example if a full repo exists but needs to be recreated with more regions.

```{r unpopulate, eval=FALSE}
## unpopulate_layers_conf
unpopulate_layers_conf(key, dir_work, dir_repo, git_url, default_scenario)

## a few extra files to delete from CHL: 
also_delete <- paste(dir_repo, 
                     c('copy_webapps_templates.r', 'ohi-travis-functions.R', 'travis-tool.sh'), sep = '/')
unlink(also_delete, recursive = TRUE, force = TRUE)
```


## Rename draft to master Part 1
```{r, eval=FALSE}
system('git status')
system('git branch -m draft master')
system('git branch')

push_branch(branch = 'master', current_msg = 'renamed draft branch to master branch') 
```

## Rename draft to master Part 2: Delete draft by hand on GitHub



# dir_M <- c('Windows' = '//mazu.nceas.ucsb.edu/ohi',
#            'Darwin'  = '/Volumes/ohi',    ### connect (cmd-K) to smb://mazu/ohi
#            'Linux'   = '/home/shares/ohi')[[ Sys.info()[['sysname']] ]]

