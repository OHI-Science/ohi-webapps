# prep_bhi.Rmd
create baltic repo. See Issue #407: https://github.com/OHI-Science/issues/issues/407

NOTE: This script superceded `prep_bhi.r`, which originally created the BHI WebApp in April 2015 with PLC Basin *Inters_BALTIC_EEZ_PLC1* regions. `prep_bhi.rmd` here recreates the BHI WebApp in August 2015 with HOLAS Basin *Intersect_HELCOMsubbasins_BALTIC_EEZ_excl_small_poly* regions. 

# Overview
Not all steps were necessary to run this time around. Steps below that were run: Setup, 1, 7. However, I've got the evals off of all of these at the moment (ie, `{r, eval=F}) so it doesn't run now when I don't want it to. 


## 1. setup
```{r setup, eval=F}


library(dplyr)
library(readr)
library(stringr)
library(rgdal)
library(raster)

dir_neptune = c('Windows' = '//neptune.nceas.ucsb.edu/data_edit',
                'Darwin'  = '/Volumes/data_edit',
                'Linux'   = '/var/data/ohi')[[ Sys.info()[['sysname']] ]]

setwd('~/github/ohi-webapps')
source('create_init.R')
source('create_functions.R')

```


## 1. view map and accompanying data; save with ohi data frame 

NOTE: `read_OGR` didn't take care of the **orphan hole** problems in the `Intersect_HELCOMsubbasins_BALTIC_EEZ_Eliminate` shp files provided by the Baltic group. But `readShapePoly` did, providing we set the coordinate reference system (CRS), which I took directly from the output that `read_OGR` gave.

```{r view map, eval=F}

# logicals for if statements below
view_shp = F
clean_spatial = F 
redo_shp = F 


# read in shp files and save with desired headers in data frame. readOGR includes a CRS but doesn't fix orphan holes
bhi_tmp = readOGR(dsn = file.path(dir_neptune, 'git-annex/clip-n-ship/bhi/spatial/custom/raw'),
              layer = 'Intersect_HELCOMsubbasins_BALTIC_EEZ_Eliminate')
# bhi_tmp
# class       : SpatialPolygonsDataFrame 
# features    : 42 
# extent      : 4210802, 5437429, 3404119, 4812329  (xmin, xmax, ymin, ymax)
# coord. ref. : +proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs 
# variables   : 15
# names       : FID_HELCOM, SB_Code,                  Name, AreaKM2, HELCOM_ID,  Shape_STAr, Shape_STLe, FID_BALTIC, OBJECTID, ID,  Name_1, Shape_Leng, Shape_Le_1, Shape_Area,        Area 
# min values  :          0,       1,             Ã…land Sea,    1208,   SEA-001,  1207968326,   392729.5,          0,        0,  1, Denmark,   483.7242,    0.00000,    6121.55,    98.62089 
# max values  :         16,      17, Western Gotland Basin,   75093,   SEA-017, 75093468124, 20986555.1,          8,        4,  9,  Sweden,  7113.7737,   90.77792,  160638.70, 31239.66735 

# # readShapePoly doesn't include a coordinate ref system (must set it) but also removes orphan holes
bhi = readShapePoly(file.path(dir_neptune, 'git-annex/clip-n-ship/bhi/spatial/custom/raw',
                   'Intersect_HELCOMsubbasins_BALTIC_EEZ_Eliminate.shp'), 
                  proj4string=CRS(bhi_tmp@proj4string@projargs) # CRS set from bhi_tmp above
bhi_orig = bhi # to archive

# viewing takes a long time
if (view_shp) plot(bhi)

# check for errors in shp file: 'orphaned hole' error encountered in Step 9 below 
if (clean_spatial) source('~/github/ohi-webapps/custom/bhi/clean_spatial_bhi.r') # will overwrite bhi with cleaned file; be sure the last line is uncommented


if (redo_shp) {
  bhi@data # view data
  bhi@data = bhi@data %>%
    mutate(rgn_id = 1:42) %>%
    dplyr::select(rgn_id,
                  area_km2 = Area,
                  cntry_name = Name_1,
                  basin_name = Name) %>%
    mutate(basin_name = str_replace_all(basin_name, '\xc5land Sea', 'Aland Sea'),
           rgn_name = paste(substr(cntry_name, 1, 3), # create rgn_name as eez - basin (eg 'Est - Gulf of Riga')
                            '-',
                            basin_name), sep=' ') %>%
    dplyr::select(rgn_id, area_km2, cntry_name, basin_name, rgn_name) # since 'sep' column exists
  
  
  # save as shapefiles
  writeOGR(bhi, dsn = file.path(dir_neptune, 'git-annex/clip-n-ship/bhi/spatial/custom'), 
           layer = 'baltic_shp', driver = 'ESRI Shapefile', overwrite=T) # will create 4 files: .dbf, .prj, .shp, .shx
  
  
  # create lookup table with unique rgn_ids
  bhi_sc = read_csv('custom/bhi/sc_studies_custom_bhi.csv'); head(bhi_sc)
  
  baltic_rgns = bhi@data %>%
    left_join(bhi_sc %>%
                dplyr::select(sc_key, 
                              cntry_name = gl_rgn_name, 
                              gl_rgn_key), 
              by='cntry_name') %>%
    mutate(baltic_rgn_key = tolower(gl_rgn_key)) %>%
    dplyr::select(-gl_rgn_key) %>%
    group_by(cntry_name) %>%
    mutate(sc_id = 1:n()); head(baltic_rgns)
  
  write_csv(baltic_rgns, 'custom/bhi/baltic_rgns_to_bhi_rgns_lookup_holas.csv')
  
}

```

## 2. add all Baltic countries to custom/bhi/sc_studies_custom_bhi.csv by hand
Note: this had already been done previously with `prep_bhi.r`

## 3. create directories in github/clip-n-ship 
Note: this had already been done previously with `prep_bhi.r`

```{r create bhi-xxx dirs, eval=F}

redo_dirs = F

if(redo_dirs) {
  ind_bhi = str_detect(bhi_sc$sc_key, 'bhi-')
  bhi_rgn = bhi_sc$sc_key[ind_bhi] # bhi_rgn = c("bhi-swe", "bhi-fin", "bhi-dnk", "bhi-deu", "bhi-est", "bhi-pol", "bhi-rus", "bhi-lva", "bhi-ltu")
  
  sapply(sprintf('~/github/clip-n-ship/%s', bhi_rgn), dir.create)
  }
```

## 4. create directories in git-annex/clip-n-ship and copy required files for populate_draft_branch()
Note: this had already been done previously with `prep_bhi.r`

```{r populate bhi-xxx dirs, eval=F}

redo_bhi_dirs = F

if (redo_bhi_dirs) {
  # first create the directories
  sapply(sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s'), bhi_rgn), dir.create)
  sapply(sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/spatial'), bhi_rgn), dir.create)
  sapply(sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/layers'), bhi_rgn), dir.create)
  
  # for each bhi_rgn
  for (b in bhi_rgn) { # b = 'bhi-rus'
    
    # copy the spatial files
    dir_in  = sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/spatial'), str_replace(b, 'bhi-', ''))
    dir_out = sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/spatial'), b)
    
    f_gcs = extension(list.files(dir_in, pattern = 'rgn_offshore_gcs'))
    
    for (f in f_gcs) {
      file.copy(sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/spatial/rgn_offshore_gcs%s'), str_replace(b, 'bhi-', ''), f),
                sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/spatial/rgn_offshore_gcs%s'), b, f), overwrite=T)
    }
    
    # copy rgn_offshore_data.csv
    file.copy(sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/spatial/rgn_offshore_data.csv'), str_replace(b, 'bhi-', '')),
              sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/spatial/rgn_offshore_data.csv'), b), overwrite=T)
    
    # copy mar_coastalpopn_inland25km_lyr.csv
    file.copy(sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/layers/mar_coastalpopn_inland25km_lyr.csv'), str_replace(b, 'bhi-', '')),
              sprintf(file.path(dir_neptune, 'git-annex/clip-n-ship/%s/layers/mar_coastalpopn_inland25km_lyr.csv'), b), overwrite=T)
    
  }  
}
```

## 5. run ohi-webapps/create_all.r through populate_draft_branch()
Note: this had already been done previously with `prep_bhi.r`

Also, when run previously with `prep_bhi.r`, problems with `create_gh_repo`; must set `repo_exists = F`

```{r run create_all.r, eval=F, echo=FALSE}
# blank chunk just so chunk and step numbering stay consistent
```


## 6. create bhi repo
Note: this had already been done previously with `prep_bhi.r`

```{r create bhi repo, eval=F}
redo_bhirepo = F

if (redo_bhirepo) {
  dir_bhi = file.path(dir_repos, 'bhi')
  
  # file.copy(list.dirs(file.path(dir_repos, 'bhi-deu')), # Apr 17 this was giving an error; I copied by hand
  #           dir_bhi) 
  
  # rename .Rproj
  file.rename(file.path(dir_bhi, 'bhi-deu.Rproj'),
              file.path(dir_bhi, 'bhi.Rproj'))
  
  # rename scenario folder
  # by hand for the moment
  }
```

## 7. bhi layers: bind possible layers for each bhi-xxx
Rerun August 2015 with new HOLAS BHI regions. 

```{r bind bhi layers, eval=F}

setwd('~/github/ohi-webapps')

# read in lookup table
lkp_baltic = read_csv('~/github/ohi-webapps/custom/bhi/baltic_rgns_to_bhi_rgns_lookup_holas.csv'); lkp_baltic

# list all layers in b
# cannot handle lsp layers; removed them from the layers folder and dealt with them separately in step 8 below
tounlink = c('lsp_prot_area_inland1km_gl2014.csv',
             'lsp_prot_area_offshore3nm_gl2014.csv',
             'lsp_prot_area_inland1km_placeholder.csv', # and when rerunning now, must first delete the placeholders
             'lsp_prot_area_offshore3nm_placeholder.csv')
for (f in tounlink) unlink(file.path(dir_repos, 'bhi/baltic2015/layers', f), recursive=T, force=T)
lyrs_list = list.files(file.path(dir_repos, 'bhi/baltic2015/layers'), glob2rx('*.csv'), full.names=T) 


# loop through all layers and then all bhi-xxx repos to create appropriate # of regions per layer
for (f in lyrs_list){ # f = "~/github/clip-n-ship/bhi/baltic2015/layers/ao_access_gl2014.csv" 
  
  cat(sprintf('processing %s ... \n', basename(f)))
  
  # read in layer, save names, delete all but headers (a bit hacky this way)
  lyr_tmp = read_csv(f)
  lyr_col = names(lyr_tmp)
  
  # only works for rgn_ids; FIS layers different
  if ('rgn_id' %in% lyr_col){
    
    # delete all data in layer
    lyr_bind = lyr_tmp %>%
      filter(rgn_id == 0)
    
    
    # for every b repo in bhi_rgn list
    for (b in bhi_rgn) { # b = 'bhi-deu'  # could rename this as key (confusing?)
      
      key = b
      source('create_init_sc.r')
      default_scenario = 'region2015'
      
      # read in b's layer
      s = read_csv(file.path(dir_repo, default_scenario, 'layers', basename(f)))
      
      # make sure classes are correct; was a problem for ico_spp_extinction_status_gl2014.csv. 
      # See http://stackoverflow.com/questions/27361081/r-assign-or-copy-column-classes-from-a-data-frame-to-another
      s[] = mapply(FUN = as, s, sapply(lyr_tmp, class), SIMPLIFY=F)
      
      # filter baltic lookp for b
      lkp_b = lkp_baltic %>%
        filter(sc_key == b)
      
      if ('area_km2' %in% lyr_col) s = s %>% select(-area_km2) # use area_km2 from lkp_b (regions) not s (nations)
      if ('rgn_name' %in% lyr_col) s = s %>% select(-rgn_name) # use rgn_name from lkp_b (regions) not s (nations)
      
      # join lookup with layer and select original columns using non-standard evaluation, ie dplyr::*_()
      t = s %>%
        rename(sc_id = rgn_id) %>%
        right_join(lkp_b, by='sc_id') %>%
        select_(.dots = lyr_col)
      
      # bind all together
      lyr_bind = bind_rows(lyr_bind, t)  
      
      }
    
    # save file
    lyr_save = lyr_bind %>%
      arrange(rgn_id)
    
    write_csv(lyr_save, f)
    
    } else {
      cat(sprintf('layer does not have rgn_id variable, do separately: %s', f))
      # "/Users/jstewart/github/clip-n-ship/bhi/baltic2015/layers/fis_b_bmsy_gl2014.csv"
      # "/Users/jstewart/github/clip-n-ship/bhi/baltic2015/layers/fis_meancatch_gl2014.csv"
      # "/Users/jstewart/github/clip-n-ship/bhi/baltic2015/layers/mar_harvest_species_gl2014.csv"
      }
  }
# These errors with MAR: I had to also move them temporarily out of the folder, although they seemed to have processed
# In addition: Warning messages:
# 1: 15 problems parsing '~/github/clip-n-ship/bhi-pol/region2015/layers/mar_harvest_tonnes_gl2014.csv'. See problems(...) for more details. 
# 2: 10 problems parsing '~/github/clip-n-ship/bhi-lva/region2015/layers/mar_harvest_tonnes_gl2014.csv'. See problems(...) for more details. 
# 3: 5 problems parsing '~/github/clip-n-ship/bhi-ltu/region2015/layers/mar_harvest_tonnes_gl2014.csv'. See problems(...) for more details. 

```
 
## 8. bhi layers: handle several layers individually 

```{r individual bhi layers, eval=FALSE}

  # recreate rgn_global_gl2014.csv
  tmp = lkp_baltic %>%
    select(rgn_id, 
           label = rgn_name)
  write_csv(tmp, file.path(dir_repos, 'bhi/baltic2015/layers/rgn_global_gl2014.csv'))
  
  
  # recreate rgn_labels.csv 
  tmp = lkp_baltic %>%
    mutate(type = 'eez',
           label = paste(str_extract(cntry_name, pattern='[A-Z][a-z][a-z]'),
                         basin_name, sep = ' - ')) %>%
    select(rgn_id, type, label)
  write_csv(tmp, file.path(dir_repos, 'bhi/baltic2015/layers/rgn_labels.csv'))
  
  # recreate rgn_area_sc2014-area.csv
  tmp = lkp_baltic %>%
    select(rgn_id, rgn_name, area_km2)
  write_csv(tmp, file.path(dir_repos, 'bhi/baltic2015/layers/rgn_area_sc2014-area.csv'))
  
  # recreate rgn_area_inland1km_gl2014.csv and rgn_area_offshore3nm_gl2014.csv
  tmp = lkp_baltic %>%
    select(rgn_id) %>%
    mutate(area_km2 = 5) # placeholder
  write_csv(tmp, file.path(dir_repos, 'bhi/baltic2015/layers/rgn_area_inland1km_gl2014.csv'))
  write_csv(tmp, file.path(dir_repos, 'bhi/baltic2015/layers/rgn_area_offshore3nm_gl2014.csv'))
  
  # recreate lsp_prot_area_inland1km_gl2014.csv and lsp_prot_area_offshore3nm_gl2014.csv
  # weird errors with not being able to see areakm2: Error in eval(expr, envir, enclos) : object 'area_km2' not found 
  tmp = read_csv(file.path(dir_repos, 'bhi/baltic2015/layers/mar_coastalpopn_inland25km_sc2014-raster.csv')) %>%
    mutate(area_km2 = 10) %>% # placeholder; NA caused errors
    select(-popsum)
  write_csv(tmp, file.path(dir_repos, 'bhi/baltic2015/layers/lsp_prot_area_inland1km_gl2014.csv'))
  write_csv(tmp, file.path(dir_repos, 'bhi/baltic2015/layers/lsp_prot_area_offshore3nm_gl2014.csv'))
  ## !!! BB came upon this too, from populate_draft_branch:  if (class(a[[fld_value]]) %in% c('factor','character')){
#       cat(sprintf('  DOH! For empty layer "%s" field "%s" is factor/character but continuing with presumption of numeric.\n', lyr, fld_value))
#     }
#   

# recreate rgn_georegions_gl2014.csv very hacky 
 tmp = read_csv(file.path(dir_repos, 'bhi/baltic2015/layers/rgn_georegions_gl2014.csv')) %>%
  select(-rgn_id) %>%
  distinct()
tmp2 = bind_rows(
  data.frame(rgn_id = 1:25) %>%
    mutate(level = tmp$level[1]) %>%
    mutate(georgn_id = tmp$georgn_id[1]), 
  data.frame(rgn_id = 1:25) %>%
    mutate(level = tmp$level[2]) %>%
    mutate(georgn_id = tmp$georgn_id[2]),
  data.frame(rgn_id = 1:25) %>%
    mutate(level = tmp$level[3]) %>%
    mutate(georgn_id = tmp$georgn_id[3]))
write_csv(tmp2, file.path(dir_repos, 'bhi/baltic2015/layers/rgn_georegions_gl2014.csv'))

# recreate rgn_georegion_labels_gl2014.csv
tmp = read_csv(file.path(dir_repos, 'bhi/baltic2015/layers/rgn_georegion_labels_gl2014.csv')) %>%
  select(-rgn_id) %>%
  distinct()
tmp2 = bind_rows(
  data.frame(rgn_id = 1:25) %>%
    mutate(level = tmp$level[1]) %>%
    mutate(label = tmp$label[1]), 
  data.frame(rgn_id = 1:25) %>%
    mutate(level = tmp$level[2]) %>%
    mutate(label = tmp$label[2]),
  data.frame(rgn_id = 1:25) %>%
    mutate(level = tmp$level[3]) %>%
    mutate(label = tmp$label[3]))
write_csv(tmp2, file.path(dir_repos, 'bhi/baltic2015/layers/rgn_georegion_labels_gl2014.csv'))

```


## 9. copy whole bhi directory to a tmp location 
important because it will be overwritten in its current location

```{r copy bhi dir, eval=FALSE}

# copy whole bhi directory to a tmp location because it will be overwritten
 system(sprintf("cp -r %s %s", # the -r means 'including subdirectories'. so `cp -r from to` 
                file.path(dir_repos, 'bhi'), 
                '~/github/ohi-webapps/tmp_baltic/_bhi_current')) 
```

## 10. proceed create_all.r 

- `custom_maps()`
- `populate_draft_branch()`
- push draft branch

```{r proceed with create_all.r, eval=FALSE}

keys_redo = 'bhi'
key = keys_redo[1]

setwd(dir_repos)
source(sprintf('%s/ohi-webapps/create_init_sc.R', dir_github))
setwd(dir_repo)

# fun custom_maps
custom_maps(key) # if orphaned hole, read in original shp file with readShapePoly and run cleangeo rather than readOGR


# run populate_draft branch()


# push




# make a temporary resilience placeholder file since errors with calculating resilince
a = read_csv('~/github/ohi-global/eez2014/scores.csv') %>%
  filter(dimension == 'resilience', 
         region_id < 26 & region_id != 0) %>%
  mutate(score = 70)
write_csv(a, '~/github/ohi-webapps/custom/bhi/resilience_scores_baltic_placeholder.csv') 


# plot(bhi) # see image below
# balt# view data
#


```